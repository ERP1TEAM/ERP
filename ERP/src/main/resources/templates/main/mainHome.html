<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>공지사항 목록</title> 
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/materialize/css/materialize.min.css}" media="screen,projection" />
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.css}" />
    <link rel="stylesheet" th:href="@{/assets/js/morris/morris-0.4.3.min.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/custom-styles.css}" />
    <link rel="stylesheet" th:href="@{/assets/js/Lightweight-Chart/cssCharts.css}" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <style>
        /* 우측 하단 고정 버튼 스타일 */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #1F2837;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
            cursor: pointer;
            z-index: 1000;
        }

        .floating-btn:hover {
            background-color: #474B54;
        }

        .floating-btn i {
            margin-right: 8px;
        }
        
		.pagination {
		    display: flex;
		    justify-content: center;
		    margin-top: 20px;
		}
		
		.pagination li {
		    display: inline-block;
		    margin: 0 5px;
		}
		
		.pagination a {
		    padding: 8px 16px;
		    border: 1px solid #ccc;
		    color: #333;
		}
		
		.pagination a:hover {
		    background-color: #ddd;
		}
		        /* 캘린더 스타일 */
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <nav th:replace="~{main/header :: header}"></nav>
        
        <div th:replace="~{main/dropdown :: dropdown}"></div>

        <div th:replace="~{main/sidebar :: sidebar}" id="sidebar"></div>

        <div id="page-wrapper" style="background-color: #e0e8f5">
            <div class="header"> 
                <h1 class="page-header">Home</h1>		
            </div>
			
            <!-- main views-->
            <div id="page-inner">
                <!-- 공지사항 출력 페이지 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-action">
                                공지사항
                            </div>
                            <div class="card-content">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                                        <thead>
                                            <tr>
                                                <th class="center" style="width: 5%;">NO</th>
                                                <th class="center" style="width: 65%;">제목</th>
                                                <th class="center" style="width: 10%;">작성자</th>
                                                <th class="center" style="width: 10%;">조회수</th>
                                                <th class="center" style="width: 10%;">작성일자</th>
                                            </tr>
                                        </thead>
                                        <tbody id="noticeTableBody">
                                            <tr th:each="notice : ${notices}">
                                                <td class="center" th:text="${notice.no}"></td>
                                                <td><a th:href="@{/main/noticeView/{id}(id=${notice.id})}" th:text="${notice.title}"></a></td>
                                                <td class="center" th:text="${notice.manager}"></td>
                                                <td class="center" th:text="${notice.views}"></td>
                                                <td class="center" th:text="${#temporals.format(notice.createdAt, 'yyyy-MM-dd')}"></td>
                                            </tr>
                                        </tbody>
                                    </table>
										<!-- 페이징 UI -->
										<div class="pagination-wrapper">
										    <ul class="pagination">
										        <li th:if="${notices.hasPrevious()}" class="page-item">
										            <a href="#" class="page-link" th:onclick="'filterNotices(' + (${notices.number - 1}) + '); return false;'">&lt;</a>
										        </li>
										        <li th:each="i : ${#numbers.sequence(0, notices.totalPages - 1)}" class="page-item" th:classappend="${i == notices.number} ? 'active' : ''">
										            <a href="#" class="page-link" th:onclick="'filterNotices(' + (${i}) + '); return false;'" th:text="${i + 1}"></a>
										        </li>
										        <li th:if="${notices.hasNext()}" class="page-item">
										            <a href="#" class="page-link" th:onclick="'filterNotices(' + (${notices.number + 1}) + '); return false;'">&gt;</a>
										        </li>
										    </ul>
										</div>

                                </div> 
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="manager" value="">
                <input type="hidden" id="companyCode" value="">
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-action">
                메모 캘린더
            </div>
            <div class="card-content">
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>
                <footer><p>Copyright 2024 ⓒ quickkoala.com by <i class="fa fa-love"></i><a href="http://quickkoala.com">Quick Koala All right reserved.</a></p></footer>
            </div>
        </div>
    </div>
    <!-- 공지사항 작성 버튼 -->
    <a href="./noticeWrite" class="floating-btn">
        <i class="fa fa-pencil"></i> 공지사항 작성
    </a>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
	<script>
	// 서버에서 사용자 이름을 가져와 페이지에 표시하는 함수
	async function fetchUserName() {
	    try {
	        const response = await fetch('/api/user-info', {
	            method: 'GET',
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            credentials: 'include' // 쿠키를 포함하여 요청
	        });

	        if (response.ok) {
	            const data = await response.json();
	            document.getElementById('manager').value = data.name; // 사용자 이름 설정
	        } else {
	            console.error('Failed to fetch user info');
	        }
	    } catch (error) {
	        console.error('Error fetching user info:', error);
	    }
	}
	// 토큰에서 사용자 이름을 가져오기
	async function fetchCompanyCode() {
	    try {
	        const response = await fetch('/api/code-info', {
	            method: 'GET',
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            credentials: 'include' // 쿠키를 포함하여 요청
	        });

	        if (response.ok) {
	            const data = await response.json();
	            document.getElementById('companyCode').value = data.code; // 사용자 소속사 코드
	        } else {
	            console.error('Failed to fetch user info');
	        }
	    } catch (error) {
	        console.error('Error fetching user info:', error);
	    }
	}
	// 공지사항 목록 필터링 및 페이징 처리 함수
	function filterNotices(page = 0) {
	    const size = 10;  // 한 페이지에 표시할 공지사항 수

	    fetch(`/main/filterNotices?page=${page}&size=${size}`)
	        .then(response => response.json())
	        .then(data => {
	            const tbody = document.getElementById('noticeTableBody');
	            tbody.innerHTML = '';  // 기존 데이터 비우기

	            data.content.forEach(notice => {
	                const row = `
	                    <tr>
	                        <td class="center">${notice.no}</td>
	                        <td><a href="/main/noticeView/${notice.id}">${notice.title}</a></td>
	                        <td>${notice.manager}</td>
	                        <td class="center">${notice.views}</td>
	                        <td class="center">${new Date(notice.createdAt).toLocaleDateString()}</td>
	                    </tr>`;
	                tbody.insertAdjacentHTML('beforeend', row);
	            });

	            // 페이징 UI 업데이트
	            currentPage = data.number;
	            totalPages = data.totalPages;
	            updatePagination();
	        })
	        .catch(error => console.error('Error fetching notices:', error));
	}

	// 페이징 UI 업데이트 함수
	function updatePagination() {
	    const pagination = document.querySelector('.pagination');
	    pagination.innerHTML = '';

	    // < 버튼
	    if (currentPage > 0) {
	        pagination.innerHTML += `<li><a href="#" onclick="filterNotices(${currentPage - 1})">&lt;</a></li>`;
	    }

	    // 페이지 번호들
	    for (let i = 0; i < totalPages; i++) {
	        // 현재 페이지에는 active 클래스를 추가
	        const activeClass = (i === currentPage) ? 'active' : '';
	        pagination.innerHTML += `<li class="${activeClass}"><a href="#" onclick="filterNotices(${i})">${i + 1}</a></li>`;
	    }

	    // > 버튼
	    if (currentPage < totalPages - 1) {
	        pagination.innerHTML += `<li><a href="#" onclick="filterNotices(${currentPage + 1})">&gt;</a></li>`;
	    }
	}

	// 초기화: 페이지 로드 시 첫 페이지 로드
	document.addEventListener('DOMContentLoaded', function() {
		fetchCompanyCode(); //로그인 관리자 정보
		fetchUserName();	//로그인 관리자 정보
	    filterNotices();  // 첫 페이지 로드
	});
	
	// 메모 저장 함수 (서버에 저장)
	function saveMemoToServer(title, start, end) {
	    const companyCode = document.getElementById("companyCode").value; 
	    const manager = document.getElementById("manager").value; 
	    
	    fetch('/api/memos/save', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify({
	            title: title,
	            startDate: start,
	            endDate: end,
	            code: companyCode,
	            manager: manager 
	        }),
	    })
	    .then(response => response.json())
	    .then(data => {
	        // 서버에서 반환된 메모 ID 사용하여 캘린더에 추가
	        calendar.addEvent({
	            id: data.id,  // 서버에서 반환된 ID 추가
	            title: title,
	            start: start,
	            end: end,
	            allDay: true,
	            extendedProps: {
	                manager: manager
	            }
	        });
	    })
	    .catch(error => console.error('Error saving memo:', error));
	}
	// 서버에서 메모 불러오기 함수
	function loadMemosFromServer(calendar) {
	    fetch('/api/memos/all')
	        .then(response => response.json())
	        .then(data => {
	            data.forEach(memo => {
	                calendar.addEvent({
	                    id: memo.id,  // 서버에서 받은 메모의 ID 추가
	                    title: memo.title,
	                    start: memo.startDate,
	                    end: memo.endDate,
	                    allDay: true,
	                    extendedProps: {  // manager를 extendedProps로 추가
	                        manager: memo.manager
	                    }
	                });
	            });
	        })
	        .catch(error => console.error('Error fetching memos:', error));
	}


	// 메모 삭제 함수 (서버에 삭제 요청)
	function deleteMemoFromServer(eventId) {
	    fetch(`/api/memos/delete/${eventId}`, {
	        method: 'DELETE',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	    })
	    .then(response => {
	        if (response.ok) {
	            console.log('메모가 삭제되었습니다.');
	        } else {
	            console.error('메모 삭제 실패');
	        }
	    })
	    .catch(error => console.error('메모 삭제 중 오류 발생:', error));
	}

	// FullCalendar 초기화 시 이벤트 클릭 핸들러 수정
	document.addEventListener('DOMContentLoaded', function() {
	    var calendarEl = document.getElementById('calendar');
	    var calendar = new FullCalendar.Calendar(calendarEl, {
	        initialView: 'dayGridMonth',
	        events: [], 
	        selectable: true,
	        select: function(info) {
	            var title = prompt('메모를 입력하세요:');
	            if (title) {
	                calendar.addEvent({
	                    title: title,
	                    start: info.startStr,
	                    end: info.endStr,
	                    allDay: true,
	                    extendedProps: { 
	                        manager: document.getElementById('manager').value  // manager 추가
	                    }
	                });
	                // 메모를 서버에 저장
	                saveMemoToServer(title, info.startStr, info.endStr);
	            }
	        },
	        eventContent: function(arg) {
	            let fullTitle = arg.event.title;
	            let truncatedTitle = fullTitle.length > 20 ? fullTitle.substring(0, 20) + '...' : fullTitle;

	            let eventElement = document.createElement('div');
	            eventElement.innerHTML = truncatedTitle;

	            // 툴팁 추가
	            eventElement.setAttribute('title', fullTitle);
	            return { domNodes: [eventElement] };
	        },
	        eventClick: function(info) {
	            // 메모 삭제 확인 창 표시
	            if (confirm(`${info.event.extendedProps.manager}  :  ${info.event.title}\n\n(메모를 삭제하시겠습니까?)`)) {
	                // FullCalendar에서 메모 제거
	                info.event.remove();

	                // 서버에 삭제 요청
	                deleteMemoFromServer(info.event.id);
	            }
	        }
	    });

	    // 페이지 로드 시 기존 메모 불러오기
	    loadMemosFromServer(calendar);
	    calendar.render();
	});

	</script>

    <script th:src="@{/assets/js/jquery-1.10.2.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <script th:src="@{/assets/materialize/js/materialize.min.js}"></script>
    <script th:src="@{/assets/js/jquery.metisMenu.js}"></script>
    <script th:src="@{/assets/js/morris/raphael-2.1.0.min.js}"></script>
    <script th:src="@{/assets/js/morris/morris.js}"></script>
    <script th:src="@{/assets/js/easypiechart.js}"></script>
    <script th:src="@{/assets/js/easypiechart-data.js}"></script>
    <script th:src="@{/assets/js/Lightweight-Chart/jquery.chart.js}"></script>
    <script th:src="@{/assets/js/custom-scripts.js}"></script>
</body>

</html>
